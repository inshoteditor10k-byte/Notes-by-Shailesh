<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultima Note & Social</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2979ff; --bg: #f0f2f5; --white: #ffffff; --text: #050505; --red: #ff3d00; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: var(--white); z-index: 2000; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .input-field { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; background: #f9f9f9; }
        .btn-auth { width: 100%; padding: 15px; border-radius: 30px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-google { background: white; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* APP LAYOUT */
        #app-layout { display: none; flex-direction: column; height: 100%; }
        header { padding: 15px; background: var(--white); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 10; }
        .profile-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        
        /* PAGES */
        .page { flex: 1; overflow-y: auto; padding: 15px; display: none; padding-bottom: 90px; }
        .page.active { display: block; }
        
        /* NOTES */
        .note-card { background: var(--white); padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border-left: 5px solid var(--primary); position: relative; }
        .note-card.private { border-left-color: var(--red); opacity: 0.8; }
        .note-title { font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        
        /* PROFILE MODAL */
        .modal { position: fixed; inset: 0; background: var(--white); z-index: 1500; display: none; flex-direction: column; overflow-y: auto; }
        .profile-header { background: linear-gradient(to bottom right, #2979ff, #00b0ff); padding: 40px 20px; color: white; text-align: center; border-radius: 0 0 30px 30px; }
        .profile-img-lg { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; margin-bottom: 10px; object-fit: cover; }
        .stats-row { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat-item { text-align: center; }
        .stat-val { font-weight: bold; font-size: 20px; }
        
        /* BIO LINKS */
        .bio-link-btn { display: block; width: 100%; background: #e3f2fd; color: var(--primary); padding: 12px; margin: 5px 0; text-align: center; border-radius: 10px; text-decoration: none; font-weight: bold; }
        
        /* NAV & FAB */
        .fab { position: fixed; bottom: 85px; right: 20px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 5px 15px rgba(41, 121, 255, 0.4); cursor: pointer; }
        .btm-nav { position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #eee; }
        .nav-icon { font-size: 22px; color: #aaa; cursor: pointer; }
        .nav-icon.active { color: var(--primary); }

        /* USER LIST */
        .user-row { display: flex; align-items: center; background: var(--white); padding: 10px; margin-bottom: 10px; border-radius: 12px; }
        .follow-btn { margin-left: auto; background: var(--primary); color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <h1 style="text-align:center; margin-bottom:20px; color:var(--primary);">App Login</h1>
        <input type="email" id="email" class="input-field" placeholder="Email">
        <input type="password" id="password" class="input-field" placeholder="Password">
        <button class="btn-auth btn-blue" onclick="emailAuth()">Login / Register</button>
        <div style="text-align:center; margin:15px; color:#888;">OR</div>
        <button class="btn-auth btn-google" onclick="googleAuth()">
            <i class="fab fa-google"></i> Continue with Google
        </button>
    </div>

    <!-- MAIN APP -->
    <div id="app-layout">
        <header>
            <h2 style="font-weight:900;">Notes<span style="color:var(--primary);">.</span></h2>
            <img id="header-pic" src="" class="profile-thumb" onclick="openProfile()">
        </header>

        <!-- TABS -->
        <div id="tab-notes" class="page active">
            <div id="notes-container"></div>
        </div>
        
        <div id="tab-search" class="page">
            <h3 style="margin-bottom:15px;">Discover People</h3>
            <div id="users-list">Loading...</div>
        </div>

        <!-- FAB -->
        <div class="fab" id="add-btn" onclick="openNoteModal()"><i class="fas fa-plus"></i></div>

        <!-- NAVIGATION -->
        <div class="btm-nav">
            <i class="fas fa-home nav-icon active" onclick="switchTab('tab-notes', this)"></i>
            <i class="fas fa-search nav-icon" onclick="switchTab('tab-search', this)"></i>
            <i class="fas fa-user nav-icon" onclick="openProfile()"></i>
        </div>
    </div>

    <!-- NOTE MODAL (Add/Edit) -->
    <div id="note-modal" class="modal" style="padding:20px; z-index:1600;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <button onclick="closeNoteModal()" style="border:none; background:transparent; font-size:16px;">Cancel</button>
            <button onclick="saveNote()" style="border:none; background:var(--primary); color:white; padding:8px 20px; border-radius:20px;">Save</button>
        </div>
        <input type="text" id="note-title" placeholder="Title" style="font-size:24px; border:none; outline:none; font-weight:bold; width:100%; margin-bottom:10px;">
        <textarea id="note-body" placeholder="Start typing..." style="width:100%; height:200px; border:none; outline:none; resize:none; font-size:16px;"></textarea>
        
        <!-- Media & Options -->
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
            <button onclick="copyNote()" style="width:100%; padding:10px; background:#eee; border:none; border-radius:10px; margin-bottom:10px;">
                <i class="fas fa-copy"></i> Copy to Clipboard
            </button>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <input type="checkbox" id="note-private" style="width:20px; height:20px;">
                <label>Hide this note (Private)</label>
            </div>
             <input type="file" id="note-media" accept="image/*">
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="modal">
        <button onclick="closeProfile()" style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.2); border:none; color:white; padding:10px; border-radius:50%;"><i class="fas fa-arrow-left"></i></button>
        <div class="profile-header">
            <img id="p-img" src="" class="profile-img-lg">
            <h2 id="p-name">Name</h2>
            <p id="p-email" style="font-size:14px; opacity:0.8;">email</p>
            <div class="stats-row">
                <div class="stat-item"><div class="stat-val" id="p-followers">0</div>Followers</div>
                <div class="stat-item"><div class="stat-val" id="p-following">0</div>Following</div>
            </div>
            <button onclick="editBio()" style="background:rgba(255,255,255,0.2); border:1px solid white; color:white; padding:5px 15px; border-radius:20px; font-size:12px;">Edit Bio & Links</button>
        </div>
        
        <div style="padding:20px;">
            <h4 style="color:#888; margin-bottom:10px;">ABOUT ME</h4>
            <p id="p-bio" style="margin-bottom:20px;">No bio set.</p>
            
            <h4 style="color:#888; margin-bottom:10px;">LINKS</h4>
            <div id="p-links"></div>

            <h4 style="color:#888; margin-top:30px; margin-bottom:10px;">SETTINGS</h4>
            <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:#f9f9f9; border-radius:10px;">
                <span>Show Hidden Notes</span>
                <input type="checkbox" id="toggle-hidden" onchange="toggleHiddenNotes()">
            </div>
            <button onclick="logout()" style="width:100%; margin-top:20px; padding:15px; background:var(--red); color:white; border:none; border-radius:10px;">Logout</button>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, doc, deleteDoc, updateDoc, setDoc, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

        // --- IMPORTANT: PUT YOUR KEYS HERE ---
        const firebaseConfig = {
    apiKey: "AIzaSyCRhz9f_CrxR07TMEIqJ3jyPcP7Y7wMksY",
    authDomain: "notes-app-a043e.firebaseapp.com",
    databaseURL: "https://notes-app-a043e-default-rtdb.firebaseio.com",
    projectId: "notes-app-a043e",
    storageBucket: "notes-app-a043e.firebasestorage.app",
    messagingSenderId: "46441351547",
    appId: "1:46441351547:web:d1f642c09ff1999885d5de"
  };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let showHidden = false;

        // AUTH
        window.googleAuth = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.emailAuth = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                if(err.code === 'auth/user-not-found') createUserWithEmailAndPassword(auth, e, p);
                else alert(err.message);
            });
        };
        window.logout = () => signOut(auth).then(()=>location.reload());

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-layout').style.display = 'flex';
                
                // Sync User to DB
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    name: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    photo: user.photoURL || `https://ui-avatars.com/api/?name=${user.email}`,
                    lastSeen: Date.now()
                }, { merge: true });

                loadMyNotes();
                setupProfile();
                loadAllUsers();
            }
        });

        // --- PROFILE SYSTEM ---
        function setupProfile() {
            onSnapshot(doc(db, "users", currentUser.uid), (doc) => {
                const data = doc.data();
                document.getElementById('header-pic').src = data.photo;
                document.getElementById('p-img').src = data.photo;
                document.getElementById('p-name').innerText = data.name;
                document.getElementById('p-email').innerText = data.email;
                document.getElementById('p-bio').innerText = data.bio || "No bio yet.";
                document.getElementById('p-followers').innerText = (data.followers || []).length;
                document.getElementById('p-following').innerText = (data.following || []).length;

                const linksDiv = document.getElementById('p-links');
                linksDiv.innerHTML = "";
                if(data.links) {
                    data.links.forEach(link => {
                        linksDiv.innerHTML += `<a href="${link.url}" target="_blank" class="bio-link-btn"><i class="fas fa-link"></i> ${link.label}</a>`;
                    });
                }
            });
        }

        window.editBio = async () => {
            const newBio = prompt("Enter Bio:");
            const linkName = prompt("Link Name (e.g. My Insta):");
            const linkUrl = prompt("Link URL (e.g. instagram.com/me):");
            
            let updateData = {};
            if(newBio) updateData.bio = newBio;
            if(linkName && linkUrl) {
                updateData.links = arrayUnion({ label: linkName, url: linkUrl.startsWith('http') ? linkUrl : 'https://' + linkUrl });
            }
            
            await updateDoc(doc(db, "users", currentUser.uid), updateData);
        };

        // --- NOTES SYSTEM ---
        function loadMyNotes() {
            const q = query(collection(db, "notes"), where("uid", "==", currentUser.uid), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('notes-container');
                div.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    if(n.isPrivate && !showHidden) return;

                    const card = document.createElement('div');
                    card.className = `note-card ${n.isPrivate ? 'private' : ''}`;
                    card.innerHTML = `
                        <div class="note-title">${n.title}</div>
                        <p>${n.text.substring(0, 50)}...</p>
                        ${n.isPrivate ? '<i class="fas fa-eye-slash" style="color:red; float:right;"></i>' : ''}
                    `;
                    card.onclick = () => {
                        alert(`Full Note:\n\n${n.title}\n\n${n.text}`);
                    };
                    div.appendChild(card);
                });
            });
        }

        window.saveNote = async () => {
            const title = document.getElementById('note-title').value;
            const text = document.getElementById('note-body').value;
            const isPrivate = document.getElementById('note-private').checked;
            
            if(!title) return alert("Title required");
            
            await addDoc(collection(db, "notes"), {
                uid: currentUser.uid,
                title, text, isPrivate,
                timestamp: Date.now()
            });
            document.getElementById('note-modal').style.display = 'none';
            // Reset fields
            document.getElementById('note-title').value = "";
            document.getElementById('note-body').value = "";
        };

        window.copyNote = () => {
            const txt = document.getElementById('note-body').value;
            navigator.clipboard.writeText(txt).then(() => alert("Copied!"));
        }

        window.toggleHiddenNotes = () => {
            showHidden = document.getElementById('toggle-hidden').checked;
            if(showHidden) {
                const pin = prompt("Enter Vault PIN (for demo just press OK):");
                if(!pin) { document.getElementById('toggle-hidden').checked = false; showHidden = false; }
            }
            loadMyNotes();
        }

        // --- SOCIAL SYSTEM ---
        function loadAllUsers() {
            const q = query(collection(db, "users"));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('users-list');
                div.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    if(u.uid === currentUser.uid) return;
                    
                    const isFollowing = (u.followers || []).includes(currentUser.uid);
                    
                    div.innerHTML += `
                        <div class="user-row">
                            <img src="${u.photo}" class="profile-thumb" style="margin-right:10px;">
                            <div>
                                <b>${u.name}</b><br>
                                <small>${u.bio || 'No bio'}</small>
                            </div>
                            <button class="follow-btn" onclick="toggleFollow('${u.uid}', ${isFollowing})">
                                ${isFollowing ? 'Unfollow' : 'Follow'}
                            </button>
                        </div>
                    `;
                });
            });
        }

        window.toggleFollow = async (targetUid, isFollowing) => {
            const targetRef = doc(db, "users", targetUid);
            const myRef = doc(db, "users", currentUser.uid);
            
            if(isFollowing) {
                await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
                await updateDoc(myRef, { following: arrayRemove(targetUid) });
            } else {
                await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
                await updateDoc(myRef, { following: arrayUnion(targetUid) });
            }
        };

        // UI HELPERS
        window.openProfile = () => document.getElementById('profile-modal').style.display = 'flex';
        window.closeProfile = () => document.getElementById('profile-modal').style.display = 'none';
        window.openNoteModal = () => document.getElementById('note-modal').style.display = 'block';
        window.closeNoteModal = () => document.getElementById('note-modal').style.display = 'none';
        
        window.switchTab = (tabId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }
    </script>
</body>
</html>
