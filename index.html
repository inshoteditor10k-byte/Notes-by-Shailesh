<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern Notes | User App</title>
    <style>
        /* üé® CORE CSS VARIABLES & THEMES */
        :root {
            --primary: #6C63FF; --bg: #f0f2f5; --card: #ffffff; --text: #1f1f1f; --sub: #757575;
            --glass: rgba(255, 255, 255, 0.7); --border: rgba(0,0,0,0.05);
            --shadow: 0 10px 30px rgba(0,0,0,0.08); --radius: 20px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* Dark Mode */
        [data-theme="dark"] { --primary: #8a84ff; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --sub: #a0a0a0; --glass: rgba(30,30,30, 0.8); --border: rgba(255,255,255,0.1); }
        /* AMOLED */
        [data-theme="amoled"] { --primary: #ffffff; --bg: #000000; --card: #000000; --text: #ffffff; --sub: #888; --glass: rgba(0,0,0,0.9); --border: #333; }
        /* Ocean */
        [data-theme="ocean"] { --primary: #00d2ff; --bg: #0f2027; --card: #203a43; --text: #fff; --glass: rgba(32,58,67, 0.8); }
        /* Neon */
        [data-theme="neon"] { --primary: #0aff00; --bg: #050505; --card: #111; --text: #0aff00; --sub: #008f00; --border: #0aff00; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); overflow: hidden; transition: 0.3s; }
        
        /* üì± UTILITIES */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border); }
        .btn { padding: 12px 24px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3); }
        .btn-ghost { background: transparent; color: var(--text); }
        .btn:active { transform: scale(0.95); }
        input, textarea { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary); }
        
        /* üöÄ SPLASH SCREEN */
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 9999; flex-direction: column; }
        .loader { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* üîê AUTH PAGE */
        #auth-view { position: fixed; inset: 0; z-index: 1000; padding: 20px; overflow-y: auto; }
        .auth-card { width: 100%; max-width: 400px; padding: 30px; border-radius: 30px; box-shadow: var(--shadow); margin: auto; }
        .social-btn { width: 100%; margin-top: 15px; background: white; color: #333; border: 1px solid #ddd; }

        /* üè† MAIN LAYOUT */
        #app-view { display: flex; flex-direction: column; height: 100vh; }
        
        /* Header */
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; position: sticky; top: 0; }
        .profile-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        /* Content Area */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        
        /* Notes Grid */
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .note-card { padding: 15px; border-radius: var(--radius); position: relative; transition: 0.2s; height: 200px; display: flex; flex-direction: column; cursor: pointer; overflow: hidden; }
        .note-card h3 { font-size: 1.1rem; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .note-card p { font-size: 0.9rem; color: var(--sub); flex: 1; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; white-space: pre-wrap; }
        .note-badge { position: absolute; top: 10px; right: 10px; font-size: 12px; background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: var(--shadow); z-index: 200; }
        .nav-item { font-size: 1.5rem; color: var(--sub); cursor: pointer; transition: 0.2s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .fab { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: var(--primary); border-radius: 50%; color: white; font-size: 2rem; box-shadow: 0 5px 20px rgba(108,99,255,0.4); border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; }

        /* üõ† MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal.open { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg); width: 100%; height: 90vh; border-radius: 30px 30px 0 0; padding: 25px; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; }
        .modal.open .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Chat UI */
        .chat-list { display: flex; flex-direction: column; gap: 15px; }
        .user-row { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 15px; background: var(--card); }
        .chat-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; }
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; }
        .msg.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.them { align-self: flex-start; background: var(--card); border-bottom-left-radius: 2px; }
        
        /* Toast */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 10px 20px; border-radius: 50px; z-index: 3000; transition: 0.3s; }
        #toast.show { transform: translateX(-50%) translateY(0); }

    </style>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>

    <!-- üî• SPLASH SCREEN -->
    <div id="splash" class="flex-center">
        <h1 style="margin-bottom: 20px; font-weight: 800; color: var(--primary)">NOTES APP</h1>
        <div class="loader"></div>
    </div>

    <!-- üî• AUTH VIEW -->
    <div id="auth-view" class="hidden flex-center">
        <div class="auth-card glass-panel">
            <h2 style="text-align: center; margin-bottom: 20px;">Welcome Back</h2>
            <input type="email" id="email" placeholder="Email Address" style="margin-bottom: 10px;">
            <input type="password" id="password" placeholder="Password" style="margin-bottom: 20px;">
            <button class="btn btn-primary" style="width: 100%" onclick="handleLogin()">Login</button>
            <button class="btn btn-ghost" style="width: 100%; margin-top: 10px" onclick="toggleAuthMode()">No account? Register</button>
            <div style="text-align: center; margin: 15px; opacity: 0.5;">OR</div>
            <button class="btn social-btn" onclick="googleLogin()">
                <span class="material-icons-round" style="color: #DB4437;">g_translate</span> Continue with Google
            </button>
        </div>
    </div>

    <!-- üî• APP VIEW -->
    <div id="app-view" class="hidden">
        <!-- Header -->
        <header class="glass-panel">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="header-profile" src="https://via.placeholder.com/40" class="profile-thumb" onclick="openProfile()">
                <div>
                    <h4 id="header-name">User</h4>
                    <small id="user-count" style="font-size: 10px; color: var(--sub)">Online: 0</small>
                </div>
            </div>
            <div>
                <span class="material-icons-round" onclick="toggleVault()" style="cursor: pointer; padding: 8px;">lock</span>
                <span class="material-icons-round" onclick="openSettings()" style="cursor: pointer; padding: 8px;">settings</span>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Search -->
            <div style="margin-bottom: 20px;">
                <input type="text" id="search-bar" placeholder="Search notes..." onkeyup="filterNotes()">
            </div>
            
            <!-- Notes Grid -->
            <div id="notes-container" class="notes-grid">
                <!-- Notes injected here -->
            </div>
        </main>

        <!-- Bottom Nav -->
        <div class="bottom-nav glass-panel">
            <span class="material-icons-round nav-item active" onclick="switchTab('home')">home</span>
            <span class="material-icons-round nav-item" onclick="openChatList()">chat</span>
            <button class="fab" onclick="openNoteEditor()">+</button>
            <span class="material-icons-round nav-item" onclick="openSocial()">people</span>
            <span class="material-icons-round nav-item" onclick="openProfile()">person</span>
        </div>
    </div>

    <!-- üî• MODALS -->
    
    <!-- Note Editor -->
    <div id="note-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Note</h3>
                <div>
                    <span class="material-icons-round" onclick="togglePin()" id="pin-btn" style="cursor:pointer; margin-right: 15px; color: var(--sub)">push_pin</span>
                    <span class="material-icons-round" onclick="closeModal('note-modal')" style="cursor:pointer">close</span>
                </div>
            </div>
            <input type="text" id="note-title" placeholder="Title" style="font-size: 1.2rem; font-weight: bold; border: none; padding-left: 0; background: transparent;">
            <textarea id="note-body" placeholder="Start typing..." style="flex: 1; border: none; padding-left: 0; background: transparent; resize: none;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-ghost" onclick="copyNote()">Copy</button>
                <button class="btn btn-ghost" style="color: red" onclick="deleteNote()">Delete</button>
                <button class="btn btn-primary" style="margin-left: auto" onclick="saveNoteAndClose()">Save</button>
            </div>
        </div>
    </div>

    <!-- Vault PIN -->
    <div id="vault-modal" class="modal" style="align-items: center; justify-content: center;">
        <div class="glass-panel" style="padding: 30px; border-radius: 20px; width: 300px; text-align: center;">
            <h3>Private Vault</h3>
            <p style="margin-bottom: 15px; color: var(--sub)">Enter 4-digit PIN</p>
            <input type="password" id="vault-pin" maxlength="4" style="text-align: center; font-size: 2rem; letter-spacing: 10px; width: 100%;">
            <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                <button class="btn btn-ghost" onclick="closeModal('vault-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="unlockVault()">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="chat-with-name">Chat</h3>
                <span class="material-icons-round" onclick="closeModal('chat-modal')" style="cursor:pointer">close</span>
            </div>
            <div id="messages-container" class="chat-box"></div>
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button class="btn btn-ghost" style="padding: 10px; border-radius: 50%" onmousedown="startRecord()" onmouseup="stopRecord()"><span class="material-icons-round">mic</span></button>
                <input type="text" id="msg-input" placeholder="Type a message...">
                <button class="btn btn-primary" onclick="sendTextMsg()">Send</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <span class="material-icons-round" onclick="closeModal('settings-modal')" style="cursor:pointer">close</span>
            </div>
            <div style="overflow-y: auto;">
                <h4>Theme</h4>
                <div style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;">
                    <button class="btn" style="background:#fff; color:#000" onclick="setTheme('light')">Light</button>
                    <button class="btn" style="background:#121212; color:#fff" onclick="setTheme('dark')">Dark</button>
                    <button class="btn" style="background:#000; color:#fff" onclick="setTheme('amoled')">AMOLED</button>
                    <button class="btn" style="background:#0f2027; color:#00d2ff" onclick="setTheme('ocean')">Ocean</button>
                    <button class="btn" style="background:#000; color:#0aff00" onclick="setTheme('neon')">Neon</button>
                </div>
                <hr style="margin: 20px 0; opacity: 0.1">
                <h4>Security</h4>
                <button class="btn btn-ghost" onclick="setupPin()">Set/Change Vault PIN</button>
                <hr style="margin: 20px 0; opacity: 0.1">
                <button class="btn btn-primary" style="width: 100%; background: #ff4757;" onclick="logout()">Logout</button>
                <button class="btn btn-ghost" style="width: 100%; margin-top: 10px; color: red;" onclick="deleteAccount()">Delete Account</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast">Notification</div>

    <!-- üî• FIREBASE SDK (Compat for single file simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        /* 
           üî• FIREBASE CONFIGURATION üî• 
           Replace this object with your real Firebase Config from the Console 
        */
        const firebaseConfig = {
    apiKey: "AIzaSyCRhz9f_CrxR07TMEIqJ3jyPcP7Y7wMksY",
    authDomain: "notes-app-a043e.firebaseapp.com",
    databaseURL: "https://notes-app-a043e-default-rtdb.firebaseio.com",
    projectId: "notes-app-a043e",
    storageBucket: "notes-app-a043e.firebasestorage.app",
    messagingSenderId: "46441351547",
    appId: "1:46441351547:web:d1f642c09ff1999885d5de"
  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Enable Offline Persistence
        db.enablePersistence().catch(err => console.log("Persistence Error:", err));

        // Global State
        let currentUser = null;
        let notesData = [];
        let currentNoteId = null;
        let isVaultUnlocked = false;
        let isRegistering = false;
        let chatRecipientId = null;
        let mediaRecorder;
        let audioChunks = [];

        // DOM Elements
        const views = { splash: '#splash', auth: '#auth-view', app: '#app-view' };
        
        // üöÄ INIT
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // Sync User to DB
                const userRef = db.collection('users').doc(user.uid);
                await userRef.set({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || 'User',
                    photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${user.email}`,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                }, { merge: true });

                updateUI(user);
                loadNotes();
                loadTheme();
                switchView('app');
            } else {
                switchView('auth');
            }
            document.querySelector(views.splash).classList.add('hidden');
        });

        function switchView(viewName) {
            Object.values(views).forEach(sel => document.querySelector(sel).classList.add('hidden'));
            document.querySelector(views[viewName]).classList.remove('hidden');
        }

        function updateUI(user) {
            document.getElementById('header-name').innerText = user.displayName || user.email.split('@')[0];
            document.getElementById('header-profile').src = user.photoURL || 'https://via.placeholder.com/40';
            
            // Get total user count
            db.collection('users').onSnapshot(snap => {
                document.getElementById('user-count').innerText = `Users: ${snap.size}`;
            });
        }

        // üîê AUTH LOGIC
        function toggleAuthMode() {
            isRegistering = !isRegistering;
            document.querySelector('h2').innerText = isRegistering ? "Create Account" : "Welcome Back";
            document.querySelector('.btn-primary').innerText = isRegistering ? "Register" : "Login";
            document.querySelector('.btn-ghost').innerText = isRegistering ? "Have account? Login" : "No account? Register";
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                if (isRegistering) {
                    await auth.createUserWithEmailAndPassword(email, pass);
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch (error) {
                showToast(error.message);
            }
        }

        async function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                showToast(error.message);
            }
        }

        function logout() {
            if(currentUser) {
                db.collection('users').doc(currentUser.uid).update({ isOnline: false });
            }
            auth.signOut();
            window.location.reload();
        }

        async function deleteAccount() {
            if(!confirm("Are you sure? This cannot be undone.")) return;
            const uid = currentUser.uid;
            await db.collection('users').doc(uid).delete();
            // In real app, cloud function deletes sub-collections
            await currentUser.delete();
            window.location.reload();
        }

        // üìù NOTES SYSTEM
        function loadNotes() {
            db.collection('notes').where('uid', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    notesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderNotes();
                });
        }

        function renderNotes() {
            const container = document.getElementById('notes-container');
            container.innerHTML = '';
            const term = document.getElementById('search-bar').value.toLowerCase();

            notesData.forEach(note => {
                // Vault Filter
                if (note.isHidden && !isVaultUnlocked) return;
                // Search Filter
                if (term && !note.title.toLowerCase().includes(term) && !note.content.toLowerCase().includes(term)) return;

                const el = document.createElement('div');
                el.className = 'glass-panel note-card';
                el.innerHTML = `
                    <h3>${note.title || 'Untitled'}</h3>
                    <p>${note.content}</p>
                    ${note.isPinned ? '<span class="note-badge">Pinned</span>' : ''}
                `;
                el.onclick = () => openNoteEditor(note);
                container.appendChild(el);
            });
        }

        function openNoteEditor(note = null) {
            currentNoteId = note ? note.id : null;
            document.getElementById('note-title').value = note ? note.title : '';
            document.getElementById('note-body').value = note ? note.content : '';
            
            // Set Pin state visual
            const pinBtn = document.getElementById('pin-btn');
            pinBtn.style.color = (note && note.isPinned) ? 'var(--primary)' : 'var(--sub)';
            pinBtn.dataset.pinned = (note && note.isPinned) ? 'true' : 'false';

            openModal('note-modal');
        }

        async function saveNoteAndClose() {
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('note-body').value;
            const isPinned = document.getElementById('pin-btn').dataset.pinned === 'true';

            if (!title && !content) return closeModal('note-modal');

            const payload = {
                uid: currentUser.uid,
                title,
                content,
                isPinned,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isHidden: isVaultUnlocked // New notes created in vault are hidden
            };

            if (currentNoteId) {
                await db.collection('notes').doc(currentNoteId).update(payload);
            } else {
                await db.collection('notes').add(payload);
            }
            closeModal('note-modal');
            showToast('Note Saved');
        }

        async function deleteNote() {
            if (currentNoteId) {
                await db.collection('notes').doc(currentNoteId).delete();
                closeModal('note-modal');
                showToast('Note Deleted');
            }
        }

        function togglePin() {
            const btn = document.getElementById('pin-btn');
            const state = btn.dataset.pinned === 'true';
            btn.dataset.pinned = !state;
            btn.style.color = !state ? 'var(--primary)' : 'var(--sub)';
        }

        function copyNote() {
            const txt = document.getElementById('note-title').value + "\n" + document.getElementById('note-body').value;
            navigator.clipboard.writeText(txt);
            showToast('Copied to clipboard');
        }

        // üôà VAULT SYSTEM
        function toggleVault() {
            if (isVaultUnlocked) {
                isVaultUnlocked = false;
                showToast('Vault Locked');
                renderNotes();
            } else {
                openModal('vault-modal');
            }
        }

        async function unlockVault() {
            const input = document.getElementById('vault-pin').value;
            // Fetch user pin
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const savedPin = userDoc.data().pin;

            if (!savedPin) {
                // First time set
                await db.collection('users').doc(currentUser.uid).update({ pin: input });
                isVaultUnlocked = true;
                closeModal('vault-modal');
                renderNotes();
                showToast('PIN Set & Vault Unlocked');
            } else if (savedPin === input) {
                isVaultUnlocked = true;
                closeModal('vault-modal');
                renderNotes();
                showToast('Vault Unlocked');
            } else {
                showToast('Wrong PIN');
                document.getElementById('vault-pin').value = '';
            }
        }

        // üé® THEME SYSTEM
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            db.collection('users').doc(currentUser.uid).update({ theme: themeName });
            localStorage.setItem('theme', themeName);
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) document.documentElement.setAttribute('data-theme', saved);
        }

        // üí¨ CHAT SYSTEM
        async function openChatList() {
            // Simplified: Just shows all users to chat with
            const snap = await db.collection('users').limit(20).get();
            const list = document.querySelector('.modal-content'); // Reuse modal logic or creating specific list
            // For simplicity in single file, reusing settings modal style but injecting list
            let html = `<div class="modal-header"><h3>Chats</h3><span class="material-icons-round" onclick="closeModal('settings-modal')">close</span></div><div class="chat-list">`;
            snap.forEach(doc => {
                if (doc.id === currentUser.uid) return;
                const d = doc.data();
                html += `
                    <div class="user-row" onclick="startChat('${doc.id}', '${d.displayName}')">
                        <img src="${d.photoURL}" class="profile-thumb">
                        <div><b>${d.displayName}</b><br><small>${d.isOnline?'Online':'Offline'}</small></div>
                    </div>
                `;
            });
            html += `</div>`;
            document.querySelector('#settings-modal .modal-content').innerHTML = html;
            openModal('settings-modal');
        }

        function startChat(uid, name) {
            chatRecipientId = uid;
            document.getElementById('chat-with-name').innerText = name;
            closeModal('settings-modal'); // Close list
            openModal('chat-modal');
            
            // Generate Chat ID (alphabetical sort to ensure uniqueness between two users)
            const chatId = [currentUser.uid, uid].sort().join('_');
            
            db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp')
                .onSnapshot(snap => {
                    const box = document.getElementById('messages-container');
                    box.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        const isMe = d.senderId === currentUser.uid;
                        box.innerHTML += `
                            <div class="msg ${isMe ? 'me' : 'them'}">
                                ${d.type === 'audio' ? `<audio controls src="${d.content}"></audio>` : d.content}
                            </div>
                        `;
                    });
                    box.scrollTop = box.scrollHeight;
                });
        }

        async function sendTextMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if(!text) return;
            
            const chatId = [currentUser.uid, chatRecipientId].sort().join('_');
            await db.collection('chats').doc(chatId).collection('messages').add({
                senderId: currentUser.uid,
                content: text,
                type: 'text',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = '';
        }

        // üé§ AUDIO RECORDING (Base64 for simplicity in this constraints)
        function startRecord() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });
                showToast("Recording...");
            });
        }

        function stopRecord() {
            if(!mediaRecorder) return;
            mediaRecorder.stop();
            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks);
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob); 
                reader.onloadend = async function() {
                    const base64data = reader.result;
                    // Limit check (Firestore doc limit 1MB, careful)
                    if(base64data.length > 900000) return showToast("Audio too long!");
                    
                    const chatId = [currentUser.uid, chatRecipientId].sort().join('_');
                    await db.collection('chats').doc(chatId).collection('messages').add({
                        senderId: currentUser.uid,
                        content: base64data,
                        type: 'audio',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            });
        }

        // üõ† HELPERS
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openSettings() { 
            // Reset content of settings modal if overwritten by chat list
            document.querySelector('#settings-modal .modal-content').innerHTML = `
                <div class="modal-header"><h3>Settings</h3><span class="material-icons-round" onclick="closeModal('settings-modal')">close</span></div>
                <div style="overflow-y: auto;">
                    <h4>Theme</h4>
                    <div style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;">
                        <button class="btn" onclick="setTheme('light')">Light</button>
                        <button class="btn" style="background:#333; color:#fff" onclick="setTheme('dark')">Dark</button>
                    </div>
                    <hr style="margin: 20px 0; opacity: 0.1">
                    <button class="btn btn-primary" onclick="logout()">Logout</button>
                </div>`; // Simplified restore
            openModal('settings-modal'); 
        }
        function openProfile() { showToast('Profile View Coming Soon'); }
        function openSocial() { openChatList(); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function filterNotes() { renderNotes(); }

    </script>
</body>
</html>
