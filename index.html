<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Notes App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #6C63FF; --bg: #ffffff; --text: #333; --card: #f4f4f4; --red: #ff4757; }
        [data-theme="dark"] { --primary: #00d2d3; --bg: #181818; --text: #fff; --card: #252525; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Login Screen */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .auth-box { text-align: center; }
        .input-group { margin-bottom: 15px; text-align: left; }
        input { width: 100%; padding: 15px; background: var(--card); border: 1px solid #ddd; border-radius: 12px; color: var(--text); outline: none; }
        .btn { width: 100%; padding: 15px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-google { background: #fff; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .error-msg { color: var(--red); font-size: 12px; margin-top: 5px; display: none; }

        /* Main UI */
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card); }
        .avatar-small { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid var(--primary); }
        
        #content-area { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .note-card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 15px; position: relative; border-left: 4px solid var(--primary); }
        .note-card.hidden-type { border-left: 4px solid var(--red); opacity: 0.7; }
        
        /* Floating Button */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; }

        /* Profile Modal */
        #profile-modal { position: fixed; inset: 0; background: var(--bg); z-index: 1500; transform: translateX(100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px; }
        #profile-modal.active { transform: translateX(0); }
        .profile-header { text-align: center; margin-bottom: 30px; }
        .profile-pic-lg { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-radius: 10px; margin-bottom: 10px; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; color: white; }
        .hide { display: none !important; }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader"><i class="fas fa-spinner fa-spin fa-2x"></i></div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-box">
            <h1 style="color:var(--primary); margin-bottom: 30px;">CloudNotes <i class="fas fa-cloud"></i></h1>
            
            <div class="input-group">
                <input type="email" id="login-email" placeholder="Email Address">
            </div>
            <div class="input-group">
                <input type="password" id="login-pass" placeholder="Password">
                <p id="auth-error" class="error-msg">Incorrect email or password</p>
            </div>
            
            <button class="btn btn-primary" onclick="handleEmailLogin()">Login / Register</button>
            <div style="margin: 15px 0; color: #888;">OR</div>
            <button class="btn btn-google" onclick="handleGoogleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Continue with Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-interface" class="hide">
        <header>
            <h2 style="font-size: 20px;">My Notes</h2>
            <img id="header-avatar" src="https://via.placeholder.com/40" class="avatar-small" onclick="openProfile()">
        </header>

        <div id="content-area">
            <!-- Notes will render here -->
            <div style="text-align:center; color:#888; margin-top:50px;" id="empty-msg">No notes yet. Click + to add.</div>
        </div>

        <div class="fab" onclick="addNote()"><i class="fas fa-plus"></i></div>
    </div>

    <!-- PROFILE MODAL (Hide/Unhide System) -->
    <div id="profile-modal">
        <div style="text-align:right;"><i class="fas fa-times fa-2x" onclick="closeProfile()"></i></div>
        <div class="profile-header">
            <img id="profile-pic" src="" class="profile-pic-lg">
            <h3 id="profile-name">User</h3>
            <p id="profile-email" style="font-size:12px; color:#888;"></p>
        </div>

        <h4 style="margin-bottom:15px; color:var(--primary);">Security & Vault</h4>
        
        <div class="toggle-row">
            <span><i class="fas fa-eye-slash"></i> Show Hidden Notes</span>
            <input type="checkbox" id="vault-toggle" onchange="toggleVault()">
        </div>

        <div class="toggle-row" onclick="toggleTheme()">
            <span><i class="fas fa-moon"></i> Dark Theme</span>
        </div>

        <button class="btn" style="background:var(--red); color:white; margin-top:20px;" onclick="logout()">Logout</button>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        // -----------------------------------------------------
        // IMPORT FIREBASE (DO NOT CHANGE)
        // -----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

        // -----------------------------------------------------
        // CONFIGURATION (PASTE YOUR KEYS HERE)
        // -----------------------------------------------------
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) {
            console.error("Firebase Config Missing!");
            alert("Error: Firebase Config not set in code. Please edit the HTML file and add your API keys.");
        }

        // -----------------------------------------------------
        // GLOBAL VARIABLES & UTILS
        // -----------------------------------------------------
        let currentUser = null;
        let showHidden = false;

        window.handleGoogleLogin = () => {
            document.getElementById('loader').style.display = 'flex';
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    document.getElementById('loader').style.display = 'none';
                    alert(error.message);
                });
        };

        window.handleEmailLogin = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errorMsg = document.getElementById('auth-error');
            
            if(!email || !pass) { alert("Please enter email and password"); return; }
            
            document.getElementById('loader').style.display = 'flex';
            errorMsg.style.display = 'none';

            // Try Login first
            signInWithEmailAndPassword(auth, email, pass)
                .then(() => { /* Auth listener handles redirect */ })
                .catch((error) => {
                    // If user not found, try to Register
                    if(error.code === 'auth/user-not-found') {
                        if(confirm("Account does not exist. Create new account?")) {
                            createUserWithEmailAndPassword(auth, email, pass)
                            .catch(e => {
                                document.getElementById('loader').style.display = 'none';
                                errorMsg.innerText = e.message;
                                errorMsg.style.display = 'block';
                            });
                        } else {
                            document.getElementById('loader').style.display = 'none';
                        }
                    } else if (error.code === 'auth/wrong-password') {
                        document.getElementById('loader').style.display = 'none';
                        errorMsg.innerText = "Wrong Password!";
                        errorMsg.style.display = 'block';
                    } else {
                        document.getElementById('loader').style.display = 'none';
                        errorMsg.innerText = error.message;
                        errorMsg.style.display = 'block';
                    }
                });
        };

        window.logout = () => {
            signOut(auth).then(() => {
                location.reload();
            });
        };

        // -----------------------------------------------------
        // APP LOGIC (REALTIME DATABASE)
        // -----------------------------------------------------
        
        // Listen to Login State
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loader').style.display = 'none';
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hide');
                document.getElementById('app-interface').classList.remove('hide');
                
                // Set Profile Data
                document.getElementById('header-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}`;
                document.getElementById('profile-pic').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}`;
                document.getElementById('profile-name').innerText = user.displayName || "User";
                document.getElementById('profile-email').innerText = user.email;

                // Sync User to Database (For Admin Panel)
                saveUserToDB(user);
                
                // Load Notes
                loadNotes();
            } else {
                document.getElementById('auth-screen').classList.remove('hide');
                document.getElementById('app-interface').classList.add('hide');
            }
        });

        async function saveUserToDB(user) {
            const userRef = doc(db, "users", user.uid);
            await setDoc(userRef, {
                uid: user.uid,
                email: user.email,
                name: user.displayName || user.email.split('@')[0],
                lastActive: new Date().toISOString()
            }, { merge: true });
        }

        function loadNotes() {
            const q = query(collection(db, "notes"), where("uid", "==", currentUser.uid), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('content-area');
                container.innerHTML = '';
                
                if(snapshot.empty) {
                    container.innerHTML = '<div style="text-align:center; color:#888; margin-top:50px;">No notes found.</div>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const note = doc.data();
                    // FILTER: Show note if NOT hidden, OR if hidden AND vault is open
                    if (!note.isHidden || (note.isHidden && showHidden)) {
                        const div = document.createElement('div');
                        div.className = `note-card ${note.isHidden ? 'hidden-type' : ''}`;
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between;">
                                <small style="color:#888">${new Date(note.timestamp).toLocaleDateString()}</small>
                                ${note.isHidden ? '<i class="fas fa-eye-slash" style="color:var(--red)"></i>' : ''}
                            </div>
                            <p style="font-size:16px; margin-top:5px;">${note.text}</p>
                            <div style="text-align:right; margin-top:10px;">
                                <button onclick="toggleHide('${doc.id}', ${!note.isHidden})" style="border:none; background:transparent; color:var(--primary); font-size:12px;">
                                    ${note.isHidden ? 'UNHIDE' : 'HIDE'}
                                </button>
                            </div>
                        `;
                        container.appendChild(div);
                    }
                });
            });
        }

        // -----------------------------------------------------
        // UI ACTIONS
        // -----------------------------------------------------
        window.addNote = async () => {
            const text = prompt("Write your note:");
            if (text) {
                const isHidden = confirm("Do you want to HIDE this note in private vault?");
                await addDoc(collection(db, "notes"), {
                    uid: currentUser.uid,
                    text: text,
                    isHidden: isHidden,
                    timestamp: Date.now()
                });
            }
        };

        window.toggleHide = async (docId, newStatus) => {
            const noteRef = doc(db, "notes", docId);
            await updateDoc(noteRef, { isHidden: newStatus });
        };

        window.openProfile = () => { document.getElementById('profile-modal').classList.add('active'); };
        window.closeProfile = () => { document.getElementById('profile-modal').classList.remove('active'); };

        window.toggleVault = () => {
            const chk = document.getElementById('vault-toggle');
            if(chk.checked) {
                const pin = prompt("Enter Vault PIN (Set any for demo):");
                if(pin) {
                    showHidden = true;
                    loadNotes(); // Refresh list
                } else {
                    chk.checked = false;
                }
            } else {
                showHidden = false;
                loadNotes(); // Refresh list
            }
        };
        
        window.toggleTheme = () => {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
        }

        // Attach functions to window for HTML access
        window.toggleHide = toggleHide;
    </script>
</body>
</html>